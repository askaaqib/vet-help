{"ast":null,"code":"import _classCallCheck from \"/home/shah/Public/projects/keltjw/mern/react/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/home/shah/Public/projects/keltjw/mern/react/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/home/shah/Public/projects/keltjw/mern/react/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/home/shah/Public/projects/keltjw/mern/react/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/home/shah/Public/projects/keltjw/mern/react/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _assertThisInitialized from \"/home/shah/Public/projects/keltjw/mern/react/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";\nvar _jsxFileName = \"/home/shah/Public/projects/keltjw/mern/react/src/components/requestHelp.js\";\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { connect } from 'react-redux';\nimport MediaHandler from './MediaHandler';\nimport Pusher from 'pusher-js';\nimport Peer from 'simple-peer';\nvar APP_KEY = '83c9614fa128f8d6027a';\n\nvar RequestHelp =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(RequestHelp, _Component);\n\n  function RequestHelp(props) {\n    var _this;\n\n    _classCallCheck(this, RequestHelp);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(RequestHelp).call(this, props));\n    _this.state = {\n      hasMedia: false,\n      otherUserid: null\n    };\n    _this.mediaHandler = new MediaHandler();\n    _this.user = {\n      id: '2',\n      name: 'hassaan'\n    };\n\n    _this.setupPusher();\n\n    _this.callTo = _this.callTo.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    _this.setupPusher = _this.setupPusher.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    _this.startPeer = _this.startPeer.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    return _this;\n  }\n\n  _createClass(RequestHelp, [{\n    key: \"componentWillMount\",\n    value: function componentWillMount() {\n      var _this2 = this;\n\n      this.mediaHandler.getPermissions().then(function (stream) {\n        _this2.setState({\n          hasMedia: true\n        });\n\n        try {\n          _this2.myVideo.srcObject = stream;\n        } catch (e) {\n          _this2.myVideo.src = window.URL.createObjectURL(stream);\n        }\n\n        _this2.myVideo.play();\n      });\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      if (!this.props.auth.isAuthenticated) {\n        this.props.history.push('/login');\n      }\n    }\n  }, {\n    key: \"setupPusher\",\n    value: function setupPusher() {\n      var _this3 = this;\n\n      this.pusher = new Pusher(APP_KEY, {\n        authEndpoint: '/api/pusher/auth',\n        cluster: 'ap2',\n        auth: {\n          params: this.user.id\n        }\n      });\n      this.channel = this.pusher.subscribe('presence-video-channel');\n      this.channel.bind(\"client-signal-\".concat(this.user.id), function (signal) {\n        var peer = _this3.peers[signal.userId]; // if peer is not already exists, we got an incoming call\n\n        if (peer === undefined) {\n          _this3.setState({\n            otherUserId: signal.userId\n          });\n\n          peer = _this3.startPeer(signal.userId, false);\n        }\n\n        peer.signal(signal.data);\n      });\n    }\n  }, {\n    key: \"startPeer\",\n    value: function startPeer(userId) {\n      var _this4 = this;\n\n      var initiator = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n      var peer = new Peer({\n        initiator: initiator,\n        stream: this.user.stream,\n        trickle: false\n      });\n      peer.on('signal', function (data) {\n        _this4.channel.trigger(\"client-signal-\".concat(userId), {\n          type: 'signal',\n          userId: _this4.user.id,\n          data: data\n        });\n      });\n      peer.on('stream', function (stream) {\n        try {\n          _this4.userVideo.srcObject = stream;\n        } catch (e) {\n          _this4.userVideo.src = URL.createObjectURL(stream);\n        }\n\n        _this4.userVideo.play();\n      });\n      peer.on('close', function () {\n        var peer = _this4.peers[userId];\n\n        if (peer !== undefined) {\n          peer.destroy();\n        }\n\n        _this4.peers[userId] = undefined;\n      });\n      return peer;\n    }\n  }, {\n    key: \"callTo\",\n    value: function callTo(userId) {\n      this.peers[userId] = this.startPeer(userId);\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this5 = this;\n\n      {\n        [1, 2, 3, 4].map(function (userId) {\n          return _this5.user.id !== userId ? React.createElement(\"button\", {\n            key: userId,\n            onClick: function onClick() {\n              return _this5.callTo(userId);\n            },\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 116\n            },\n            __self: this\n          }, \"Call \", userId) : null;\n        });\n      }\n      return React.createElement(\"div\", {\n        className: \"main-dasboard\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 120\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"container mt-5\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 121\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"card dash-main-card\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 122\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"video-container\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 123\n        },\n        __self: this\n      }, React.createElement(\"video\", {\n        className: \"my-video\",\n        ref: function ref(_ref) {\n          _this5.myVideo = _ref;\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 124\n        },\n        __self: this\n      }), React.createElement(\"video\", {\n        className: \"user-video\",\n        ref: function ref(_ref2) {\n          _this5.userVideo = _ref2;\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 125\n        },\n        __self: this\n      })))));\n    }\n  }]);\n\n  return RequestHelp;\n}(Component);\n\nRequestHelp.propTypes = {\n  auth: PropTypes.object.isRequired\n};\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    auth: state.auth\n  };\n};\n\nexport default connect(mapStateToProps)(RequestHelp);","map":{"version":3,"sources":["/home/shah/Public/projects/keltjw/mern/react/src/components/requestHelp.js"],"names":["React","Component","PropTypes","connect","MediaHandler","Pusher","Peer","APP_KEY","RequestHelp","props","state","hasMedia","otherUserid","mediaHandler","user","id","name","setupPusher","callTo","bind","startPeer","getPermissions","then","stream","setState","myVideo","srcObject","e","src","window","URL","createObjectURL","play","auth","isAuthenticated","history","push","pusher","authEndpoint","cluster","params","channel","subscribe","signal","peer","peers","userId","undefined","otherUserId","data","initiator","trickle","on","trigger","type","userVideo","destroy","map","ref","propTypes","object","isRequired","mapStateToProps"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { connect } from 'react-redux';\nimport MediaHandler from './MediaHandler';\nimport Pusher from 'pusher-js';\nimport Peer from 'simple-peer';\n\nconst APP_KEY = '83c9614fa128f8d6027a';\n\nclass RequestHelp extends Component {\n    constructor(props) {\n        super(props);\n        this.state = {\n            hasMedia: false,\n            otherUserid: null\n          }\n        this.mediaHandler = new MediaHandler();\n\n        this.user = {id:'2', name: 'hassaan'}\n\n        this.setupPusher();\n\n        this.callTo = this.callTo.bind(this);\n        this.setupPusher = this.setupPusher.bind(this);\n        this.startPeer = this.startPeer.bind(this);\n    }\n\n    componentWillMount() {\n        this.mediaHandler.getPermissions()\n            .then((stream) => {\n                this.setState({hasMedia:true});\n\n                try {\n                    this.myVideo.srcObject = stream;\n                  } catch (e) {\n                    this.myVideo.src = window.URL.createObjectURL(stream);\n                  }\n\n                this.myVideo.play();\n            })\n    }\n\n    componentDidMount() {\n        if(!this.props.auth.isAuthenticated) {\n            this.props.history.push('/login');\n        }\n    }\n\n    setupPusher() {\n        this.pusher = new Pusher(APP_KEY, {\n            authEndpoint: '/api/pusher/auth',\n            cluster: 'ap2',\n            auth: {\n                params: this.user.id,\n            }\n        });\n\n        this.channel = this.pusher.subscribe('presence-video-channel');\n\n        this.channel.bind(`client-signal-${this.user.id}`, (signal) => {\n            let peer = this.peers[signal.userId];\n\n            // if peer is not already exists, we got an incoming call\n            if(peer === undefined) {\n                this.setState({otherUserId: signal.userId});\n                peer = this.startPeer(signal.userId, false);\n            }\n\n            peer.signal(signal.data);\n        });\n    }\n\n    startPeer(userId, initiator = true) {\n        const peer = new Peer({\n            initiator,\n            stream: this.user.stream,\n            trickle: false\n        });\n\n        peer.on('signal', (data) => {\n            this.channel.trigger(`client-signal-${userId}`, {\n                type: 'signal',\n                userId: this.user.id,\n                data: data\n            });\n        });\n\n        peer.on('stream', (stream) => {\n            try {\n                this.userVideo.srcObject = stream;\n            } catch (e) {\n                this.userVideo.src = URL.createObjectURL(stream);\n            }\n\n            this.userVideo.play();\n        });\n\n        peer.on('close', () => {\n            let peer = this.peers[userId];\n            if(peer !== undefined) {\n                peer.destroy();\n            }\n\n            this.peers[userId] = undefined;\n        });\n\n        return peer;\n    }\n\n    callTo(userId) {\n        this.peers[userId] = this.startPeer(userId);\n    }\n\n    render() { \n        {[1,2,3,4].map((userId) => {\n            return this.user.id !== userId ? <button key={userId} onClick={() => this.callTo(userId)}>Call {userId}</button> : null;\n        })}\n\n        return ( \n            <div className=\"main-dasboard\">\n              <div className=\"container mt-5\">\n                <div className=\"card dash-main-card\">\n                    <div className=\"video-container\">\n                        <video className=\"my-video\" ref={(ref) => {this.myVideo = ref;}}></video>              \n                        <video className=\"user-video\" ref={(ref) => {this.userVideo = ref;}}></video>    \n                    </div>          \n                </div>\n              </div>\n            </div>\n         );\n    }\n}\n\n\n \nRequestHelp.propTypes = {\n    auth: PropTypes.object.isRequired,\n}\n\nconst mapStateToProps = (state) => ({\n    auth: state.auth,\n})\n\nexport  default connect(mapStateToProps)(RequestHelp)"]},"metadata":{},"sourceType":"module"}